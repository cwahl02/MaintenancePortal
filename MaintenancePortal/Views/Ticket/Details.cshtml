@model TicketEditableViewModel

<section id="ticketContainer">
    <!-- The content will be injected here by JavaScript -->
    @await Html.PartialAsync("_TicketDetails", Model)  <!-- Initial render of ticket details -->
</section>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this ticket? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Ensure the model properties are serialized correctly from Razor
    let currentTitle = '@Model.Title';  // Directly use Razor to inject values
    let currentDescription = '@Model.Description';  // Ensure the description is a string
    const ticketId = @Model.Id;  // Directly inject ticketId

    // The HTML structure for view and edit modes
    function getViewModeHTML() {
        return `
            <div class="card-body">
                <div id="ticketHeader">
                    <div class="view-mode d-flex justify-content-between align-items-center">
                        <h3 id="ticketTitleDisplay">${currentTitle} <span class="text-secondary fw-light">#${ticketId}</span></h3>
                        <button class="btn btn-outline-primary" onclick="toggleEditMode(true)">Edit</button>
                    </div>
                </div>
                <hr />
                <h5>Description</h5>
                <div id="ticketDescription">
                    <p id="ticketDescriptionDisplay">${currentDescription}</p>
                </div>
            </div>
        `;
    }

    function getEditModeHTML() {
        return `
            <div class="card-body">
                <div id="ticketHeader">
                    <div class="edit-mode d-flex">
                        <input id="ticketTitle" type="text" class="form-control" value="${currentTitle}" />
                        <button class="btn btn-secondary mt-2" onclick="toggleEditMode(false)">Cancel</button>
                        <button class="btn btn-primary mt-2" onclick="updateTicket()">Save</button>
                    </div>
                </div>
                <hr />
                <h5>Description</h5>
                <div id="ticketDescription">
                    <textarea id="ticketDescriptionInput" class="form-control" rows="5">${currentDescription}</textarea>
                </div>
                <hr />
                <button class="btn btn-danger mt-3" onclick="showDeleteModal()">Delete Ticket</button>
            </div>
        `;
    }

    // Toggle between view and edit modes
    function toggleEditMode(isEdit) {
        const ticketContainer = document.getElementById('ticketContainer');
        if (isEdit) {
            // Inject the edit mode HTML
            ticketContainer.innerHTML = getEditModeHTML();
        } else {
            // Inject the view mode HTML
            ticketContainer.innerHTML = getViewModeHTML();
        }
    }

    function saveTicket() {
        var updatedTicket = {
            Id: @Model.Id,
            Title: document.getElementById('ticketTitle').value,
            Description: document.getElementById('ticketDescriptionInput').value
        };

        $.ajax({
            url: '@Url.Action("Update", "Ticket")',
            type: 'POST',
            data: updatedTicket,
            success: function(response) {
                // Replace the ticketContainer's content with updated ticket details
                document.getElementById('ticketContainer').innerHTML = response;
            },
            error: function() {
                alert('An error occurred while saving the ticket.');
            }
        });
    }

    function cancelEdit() {
        $.ajax({
            url: '@Url.Action("Details", "Ticket")',
            type: 'GET',
            success: function(response) {
                document.getElementById('ticketContainer').innerHTML = response;
            },
            error: function() {
                alert('An error occurred while cancelling the edit.');
            }
        });
    }

    // Function to show the delete confirmation modal
    function showDeleteModal() {
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    // Function to confirm deletion and send the request
    function confirmDelete() {
        $.ajax({
            url: '@Url.Action("Delete", "Ticket")',  // The action URL for deleting the ticket
            type: 'POST',
            data: { id: ticketId },  // Send the ticket ID to the server
            success: function(response) {
                if (response.success) {
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    deleteModal.hide();  // Hide the modal

                    // Redirect or perform any other action after successful deletion
                    window.location.href =  response.redirectUrl; // Redirect to the ticket list page
                } else {
                    alert('Failed to delete ticket: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('An error occurred while deleting the ticket: ' + error);
            }
        });
    }

    // Initialize the page in view mode on load
    document.addEventListener('DOMContentLoaded', function() {
        toggleEditMode(false);  // Start with view mode on page load
    });
</script>
